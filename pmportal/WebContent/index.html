<!DOCTYPE HTML>
<html lang="en">
<head>
<title>PMPortal Dashboard</title>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="style/main.css">
<script type="text/javascript" src="scripts/jquery-3.0.0.js"></script>
</head>
<body>
	<header>
		<div class="dropdown">
			<button type="button" data-toggle="dropdown"
				class="btn btn-info dropdown-toggle">
				Known Users<span class="caret"></span>
			</button>
			<ul class="dropdown-menu" id="userList">
			</ul>
		</div>
	</header>
	<div class="row">
		<div class="col-lg-6 col-lg-offset-3" id="login">
			<h2>PMPortal Login</h2>

			<div id="loginInput">
				<span class="inputTag">Username</span> <br> <input type="text"
					id="uname" /> <br> <span class="inputTag">Password</span> <br>
				<input type="password" id="pass" /> <br>
				<span class="inputTag">Jira URL</span> <br> <input type="url"
					id="url" /><br>
				<br> <input type="button" id="loginButton" value="Log In"
					onclick="login()" /> <br>
				<br>
				<input type="checkbox" id="rememberBox" /> <span class="inputTag">Remember
					Me</span> <br> <br>
				<p style="color: red; visibility: hidden" id="fail">Login
					failed! Double check your login info, and make sure the Jira URL is
					correct; it is generally "http://serverURL" or
					"http://serverURL/jira"</p>
			</div>
		</div>

	</div>

	<script src="scripts/cookiehandler.js"></script>
	<script src="scripts/jquery-1.12.4.min.js"></script>
	<script src="scripts/bootstrap.min.js"></script>
	<script>
var username=getCookie("username").toString();
if (username!="") {
	$("#uname").val(username);
	$("#url").val(getCookie("url"));
	$("#rememberBox").prop("checked", true);
};
var hostURL=window.location.host;
var configResource="http://" + hostURL+"/pmportal/rest/config/get";
var responseObject;
$.ajax({
	url: configResource,
	dataType: "json"
}).fail(function(xhr, status, errorThrown ) {
	console.log("Error: " + errorThrown );
	console.log("Status: " + status );
	console.dir(xhr);
}).done(function(jsonObject){
	responseObject = jsonObject;
	userArray = responseObject.users;
	$.each(userArray, function (index, user) {
		$("#userList").append("<li>" + user.username +", " + user.url + "</li>");
	});
});

$(document).ready(function(){
	$("#userList").on( "click", "li" , function () {
		var item = $(this).text();
		$.each(userArray, function (index, user) {
			if((user.username+", " + user.url) == item) {
				$("#uname").val(user.username);
				$("#url").val(user.url);
				$("#rememberBox").prop("checked", true);
			}
		});
	});
});


function login(){
	var uname=$("#uname").val();
	var pass=$("#pass").val();
	var baseURL=$("#url").val();
	var remember=$("#rememberBox").prop("checked");
	var testResource="http://"+hostURL+"/pmportal/rest/test/login/" + uname + "/" + pass + "/" +baseURL;
	var exists=false;
	$.ajax({
		type:"GET",
		dataType:"text",
		url:testResource
	}).fail(function( xhr, status, errorThrown ) {
		console.log( "Error: " + errorThrown );
		console.log( "Status: " + status );
		console.dir( xhr );
		alert("Failed to contact server!");
	}).done(function(response){
		if (response=="Success"){
			setCookie(uname, pass, baseURL, remember);
			//check if the user is already in the system
			$.each(userArray, function (index, user) {
				if (uname==user.username){
					exists=true;
				};
			});
			if (exists){
				settingsCookie(user.email);
				window.location="home.html";
			}else{
				saveToConfig(uname, pass, baseURL, "", "0.8", "1.25", "0.8", "1.25", "10");
			};
		}else{
			$("#fail").css("visibility","visible");
};
});
};
function saveToConfig(user, pass, baseURL, eaddress, seaMin, seaMax, eeaMin, eeaMax, bugMax){
	var request="{\"username\":\"" + user+"\", \"password\":\""+ pass + "\", \"url\":\"" + baseURL+"\", \"email\":\"" + eaddress+"\", \"seaMin\":\""+seaMin+"\", \"seaMax\":\""+seaMax+"\", \"eeaMin\":\""+eeaMin+"\", \"eeaMax\":\""+eeaMax+"\", \"bugMax\":\""+bugMax+"\"}";
	var resource="http://"+hostURL+"/pmportal/rest/config/save";
	$.ajax({
		type:"POST",
		data:request,
		dataType:"text",
		url:resource
	}).fail(function( xhr, status, errorThrown ) {
		console.log( "Error: " + errorThrown );
		console.log( "Status: " + status );
		console.dir( xhr );
		alert("Failed to register your credentials with the server. You can continue, but you will not be remembered by the server.");
		window.location="home.html";
	}).done(function(){
		window.location="home.html";
});	
};
</script>
</body>
</html>